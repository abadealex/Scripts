{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block styles %}
<style>
  body {
    background-color: #f8f9fa !important; /* add !important if base styles override */
  }
  .card {
    border-radius: 1rem;
  }
  .btn-success {
    background-color: #28a745;
    border: none;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="mb-4 text-primary">üë©‚Äçüè´ Teacher Dashboard</h1>
  <p class="lead">Welcome, <strong>{{ teacher_name }}</strong>!</p>

  <!-- Create Test Form -->
  <div class="card mb-5 shadow-sm border-primary">
    <div class="card-header bg-primary text-white">
      <h2 class="h5 mb-0">Create New Test</h2>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('teacher_bp.create_test') }}">
        {{ form.hidden_tag() }}

        <div class="mb-3">
          {{ form.test_title.label(class="form-label") }}
          {{ form.test_title(class="form-control", placeholder="Enter test title") }}
        </div>

        <div class="mb-3">
          {{ form.subject.label(class="form-label") }}
          {{ form.subject(class="form-select") }}
        </div>

        <div class="mb-3">
          {{ form.grade_level.label(class="form-label") }}
          {{ form.grade_level(class="form-select") }}
        </div>

        <div class="mb-3">
          {{ form.exam_date.label(class="form-label") }}
          {{ form.exam_date(class="form-control", placeholder="YYYY-MM-DD") }}
        </div>

        <div class="mb-3">
          {{ form.description.label(class="form-label") }}
          {{ form.description(class="form-control", rows="3", placeholder="Add test description") }}
        </div>

        {{ form.submit(class="btn btn-success rounded-pill px-4") }}
      </form>
    </div>
  </div>

  <hr>

  <h2 class="mb-4 text-secondary">Your Uploaded Tests</h2>

  {% if tests %}
    <div class="row gy-4">
      {% for test in tests %}
        <div class="col-md-6 col-lg-4">
          <div class="card shadow-sm h-100 border-info">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-1 text-primary">
                {{ test.title }}
                <small class="text-muted fs-6">({{ test.date.strftime('%Y-%m-%d') }})</small>
              </h5>
              <p class="card-text mb-3">
                <span class="badge bg-info text-dark me-2">{{ test.subject }}</span>
                <span class="badge bg-secondary">{{ test.grade_level }}</span>
              </p>

              <ul class="list-unstyled mb-4 flex-grow-1 small">
                <li><strong>Marking Guide:</strong>
                  {% if test.file_guide_url %}
                    <a href="{{ test.file_guide_url }}" target="_blank" class="link-primary fw-semibold">View PDF</a>
                  {% else %}
                    <span class="badge bg-danger">Not uploaded</span>
                  {% endif %}
                </li>
                <li><strong>Rubric:</strong>
                  {% if test.file_rubric_url %}
                    <a href="{{ test.file_rubric_url }}" target="_blank" class="link-primary fw-semibold">View PDF</a>
                  {% else %}
                    <span class="badge bg-danger">Not uploaded</span>
                  {% endif %}
                </li>
                <li><strong>Answered Script:</strong>
                  {% if test.answered_script_url %}
                    <a href="{{ test.answered_script_url }}" target="_blank" class="link-primary fw-semibold">View PDF</a>
                  {% else %}
                    <span class="badge bg-danger">Not uploaded</span>
                  {% endif %}
                </li>
                <li><strong>Student Submissions:</strong>
                  {% if test.submissions and test.submissions|length > 0 %}
                    <ul class="list-unstyled ms-3 mt-1 small">
                      {% for submission in test.submissions %}
                        <li>
                          <a href="{{ submission.file_url }}" target="_blank" class="link-secondary text-decoration-underline">
                            {{ submission.filename }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <span class="badge bg-warning text-dark">No student submissions uploaded</span>
                  {% endif %}
                </li>
              </ul>

              <!-- OCR Progress UI -->
              <div id="ocr-progress-container-{{ test.id }}" style="display:none; margin-top:20px;">
                <label><strong>Processing OCR:</strong></label>
                <div class="progress rounded-pill">
                  <div id="ocr-progress-bar-{{ test.id }}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
                    0%
                  </div>
                </div>
              </div>

              <div class="mt-auto d-flex gap-2 flex-wrap">
                <a href="{{ url_for('teacher_bp.review_test', test_id=test.id) }}" class="btn btn-info btn-sm rounded-pill flex-grow-1 flex-md-grow-0">
                  Review Test
                </a>

                <form method="POST" action="{{ url_for('teacher_bp.start_ai_grading', test_id=test.id) }}" class="m-0 flex-grow-1 flex-md-grow-0" onsubmit="startGrading(event, {{ test.id }})">
                  {{ ai_grading_form.csrf_token }}
                  <button type="submit" class="btn btn-success btn-sm rounded-pill w-100">
                    Start AI Grading
                  </button>
                </form>

                <form method="POST" action="{{ url_for('teacher_bp.delete_test', test_id=test.id) }}" class="m-0 flex-grow-1 flex-md-grow-0" onsubmit="return confirm('Are you sure you want to delete this test and all related submissions?');">
                  {{ ai_grading_form.csrf_token }}
                  <button type="submit" class="btn btn-danger btn-sm rounded-pill w-100">
                    Delete Test
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">
      No tests uploaded yet. <a href="{{ url_for('teacher_bp.upload_test_materials') }}" class="alert-link">Upload a new test</a>.
    </div>
  {% endif %}
</div>

<script>
function startGrading(event, testId) {
  event.preventDefault();
  const form = event.target;

  fetch(form.action, {
    method: 'POST',
    headers: { 'X-CSRFToken': form.querySelector('[name=csrf_token]').value }
  })
  .then(response => response.json())
  .then(data => {
    if (data.task_id) {
      pollOCRStatus(data.task_id, testId);
    } else {
      alert('Failed to start grading task.');
    }
  })
  .catch(() => alert('Error starting task.'));
}

function pollOCRStatus(taskId, testId) {
  const bar = document.getElementById(`ocr-progress-bar-${testId}`);
  const container = document.getElementById(`ocr-progress-container-${testId}`);
  container.style.display = 'block';

  function updateStatus() {
    fetch(`/task_status/${taskId}`)
      .then(response => response.json())
      .then(data => {
        if (data.state === 'PROGRESS') {
          const percent = data.status.progress || 0;
          bar.style.width = percent + '%';
          bar.innerText = percent + '%';
          setTimeout(updateStatus, 1000);
        } else if (data.state === 'SUCCESS') {
          bar.style.width = '100%';
          bar.innerText = '‚úÖ Complete';
          bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
          bar.classList.add('bg-success');
        } else if (data.state === 'FAILURE') {
          bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
          bar.classList.add('bg-danger');
          bar.innerText = '‚ùå Failed';
        }
      });
  }

  updateStatus();
}
</script>
{% endblock %}
